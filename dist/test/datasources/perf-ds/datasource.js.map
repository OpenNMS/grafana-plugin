{"version":3,"sources":["../../../../src/datasources/perf-ds/datasource.js"],"names":["OpenNMSDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","searchLimit","target","options","query","buildQuery","request","source","length","datasourceRequest","data","method","headers","defer","resolve","measurements","when","then","response","status","message","processMeasurementsResponse","title","undefined","interpolatedQuery","first","interpolateValue","nodeFilterRegex","nodeResourcesRegex","nodeFilterQuery","match","metricFindNodeFilterQuery","nodeCriteria","metricFindNodeResourceQuery","params","filterRule","limit","count","totalCount","console","warn","results","each","node","id","toString","foreignId","foreignSource","push","text","label","value","expandable","encodeURIComponent","getNodeResource","depth","children","resource","resourceWithoutNodePrefix","self","start","range","from","valueOf","end","to","step","Math","floor","maxDataPoints","targets","transient","hide","Attribute","nodeId","resourceId","attribute","aggregation","subattribute","datasource","concat","interpolateSourceVariables","interpolatedSource","getRemoteResourceId","Expression","expression","interpolateExpressionVariables","Filter","filter","interpolatedFilterParms","interpolateVariables","filterParameters","keys","filters","map","filterParms","parameters","key","callback","entry","object","attributes","variables","templateVariable","variable","isString","current","option","comparator","orderBy","order","sysName","interpolatedNodeId","flattenResourcesWithAttributes","interpolatedResourceId","remoteResourceId","toLowerCase","rrdGraphAttributes","indexOf","sort","labels","columns","timestamps","series","i","j","nRows","nCols","datapoints","values","resources","resourcesWithAttributes","Object","prefix"],"mappings":"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","file":"datasource.js","sourcesContent":["import {QueryType} from './constants';\nimport {interpolate} from \"./interpolate\";\nimport _ from 'lodash';\n\nexport class OpenNMSDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.$q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n\n    this.searchLimit = 25;\n    this.target = {};\n  }\n\n  query(options) {\n    // Generate the query\n    var query = this.buildQuery(options);\n\n    // Issue the request\n    var request;\n    if (query.source.length > 0) {\n      request = this.backendSrv.datasourceRequest({\n        url: this.url + '/rest/measurements',\n        data: query,\n        method: 'POST',\n        headers: {'Content-Type': 'application/json'}\n      });\n    } else {\n      // There are no sources listed, use an empty set of measurements\n      request = this.$q.defer();\n      request.resolve({measurements: []});\n    }\n\n    // Convert the results to the expected format\n    return this.$q.when(request).then(function (response) {\n      if (response.status !== 200) {\n        throw { message: 'Query failed.' };\n      }\n      return OpenNMSDatasource.processMeasurementsResponse(response);\n    });\n  }\n\n  // Used for testing the connection from the datasource configuration page\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/info',\n      method: 'GET'\n    }).then(response => {\n      if (response.status === 200) {\n        return {status: \"success\", message: \"Data source is working!\", title: \"Success\"};\n      }\n    });\n  }\n\n  // Used by template queries\n  metricFindQuery(query) {\n    if (query === null || query === undefined || query === \"\") {\n      return this.$q.resolve([]);\n    }\n\n    var interpolatedQuery = _.first(this.interpolateValue(query));\n    var nodeFilterRegex = /nodeFilter\\((.*)\\)/;\n    var nodeResourcesRegex = /nodeResources\\((.*)\\)/;\n\n    if (interpolatedQuery !== undefined) {\n      var nodeFilterQuery = interpolatedQuery.match(nodeFilterRegex);\n      if (nodeFilterQuery) {\n        return this.metricFindNodeFilterQuery(nodeFilterQuery[1]);\n      }\n\n      var nodeCriteria = interpolatedQuery.match(nodeResourcesRegex);\n      if (nodeCriteria) {\n        return this.metricFindNodeResourceQuery(nodeCriteria[1]);\n      }\n    }\n\n    return this.$q.resolve([]);\n  }\n\n  metricFindNodeFilterQuery(query) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/nodes',\n      method: 'GET',\n      params: {\n        filterRule: query,\n        limit: 0\n      }\n    }).then(function (response) {\n      if (response.data.count > response.data.totalCount) {\n        console.warn(\"Filter matches \" + response.data.totalCount + \" records, but only \" + response.data.count + \" will be used.\");\n      }\n      var results = [];\n      _.each(response.data.node, function (node) {\n        var nodeCriteria = node.id.toString();\n        if (node.foreignId !== null && node.foreignSource !== null) {\n          nodeCriteria = node.foreignSource + \":\" + node.foreignId;\n        }\n        results.push({text: node.label, value: nodeCriteria, expandable: true});\n      });\n      return results;\n    });\n  }\n\n  metricFindNodeResourceQuery(query) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/resources/' + encodeURIComponent(OpenNMSDatasource.getNodeResource(query)),\n      method: 'GET',\n      params: {\n        depth: 1\n      }\n    }).then(function (response) {\n      var results = [];\n      _.each(response.data.children.resource, function (resource) {\n        var resourceWithoutNodePrefix = resource.id.match(/node(Source)?\\[.*?\\]\\.(.*)/);\n        if (resourceWithoutNodePrefix) {\n          results.push({text: resourceWithoutNodePrefix[2], expandable: true});\n        }\n      });\n      return results;\n    });\n  }\n\n  buildQuery(options) {\n    var self = this,\n      start = options.range.from.valueOf(),\n      end = options.range.to.valueOf(),\n      step = Math.floor((end - start) / options.maxDataPoints);\n\n    var query = {\n      \"start\": start,\n      \"end\": end,\n      \"step\": step,\n      \"maxrows\": options.maxDataPoints,\n      \"source\": [],\n      \"expression\": []\n    };\n\n    _.each(options.targets, function (target) {\n      var transient = \"false\";\n      if (target.hide) {\n        transient = true;\n      }\n\n      if (target.type === QueryType.Attribute) {\n        if (!((target.nodeId && target.resourceId && target.attribute))) {\n          return;\n        }\n\n        var label = target.label;\n        if (label === undefined || label === '') {\n          label = target.attribute;\n        }\n\n        // Build the source\n        var source = {\n          \"aggregation\": target.aggregation,\n          \"attribute\": target.attribute,\n          \"label\": label,\n          \"resourceId\": target.resourceId,\n          \"nodeId\": target.nodeId, // temporary attribute used for interpolation\n          \"transient\": transient\n        };\n\n        if (target.subattribute !== undefined && target.subattribute !== '') {\n          source.datasource = target.subattribute;\n        }\n\n        // Perform variable substitution - may generate additional queries\n        query.source = query.source.concat(self.interpolateSourceVariables(source, (interpolatedSource) => {\n          // Calculate the effective resource id after the interpolation\n          interpolatedSource.resourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedSource.nodeId, interpolatedSource.resourceId);\n          delete interpolatedSource.nodeId;\n        }));\n      } else if (target.type === QueryType.Expression) {\n        if (!((target.label && target.expression))) {\n          return;\n        }\n\n        // Build the expression\n        var expression = {\n          \"label\": target.label,\n          \"value\": target.expression,\n          \"transient\": transient\n        };\n\n        // Perform variable substitution - may generate additional expressions\n        query.expression = query.expression.concat(self.interpolateExpressionVariables(expression));\n      } else if (target.type === QueryType.Filter) {\n        if (!((target.filter))) {\n          return;\n        }\n\n        // Interpolate the filter parameters\n        var interpolatedFilterParms = self.interpolateVariables(target.filterParameters, _.keys(target.filterParameters));\n\n        var filters = _.map(interpolatedFilterParms, (filterParms) => {\n          // Build the filter definition\n          var parameters = [];\n          _.each(filterParms, function (value, key) {\n            // Skip parameters with undefined or empty values\n            if (value === undefined || value === '' || value === null) {\n              return;\n            }\n\n            parameters.push({\n              'key': key,\n              'value': value\n            });\n          });\n\n          return {\n            \"name\": target.filter.name,\n            \"parameter\": parameters\n          };\n        });\n\n        // Only add the filter attribute to the query when one or more filters are specified since\n        // OpenNMS versions before 17.0.0 do not support it\n        if (!query.filter) {\n          query.filter = filters;\n        } else {\n          query.filter = query.filter.concat(filters);\n        }\n      }\n    });\n\n    return query;\n  }\n\n  interpolateSourceVariables(source, callback) {\n    return this.interpolateVariables(source, ['nodeId', 'resourceId', 'attribute', 'datasource', 'label'], callback);\n  }\n\n  interpolateExpressionVariables(expression) {\n    return this.interpolateVariables(expression, ['value', 'label']);\n  }\n\n  interpolateValue(value) {\n    return _.map(this.interpolateVariables({'value': value}, ['value']), function(entry) {\n      return entry.value;\n    });\n  }\n\n  interpolateVariables(object, attributes, callback) {\n    // Reformat the variables to work with our interpolate function\n    var variables = [];\n    _.each(this.templateSrv.variables, function(templateVariable) {\n      var variable = {\n        name: templateVariable.name,\n        value: []\n      };\n\n      // Single-valued?\n      if (_.isString(templateVariable.current.value)) {\n        variable.value.push(templateVariable.current.value);\n      } else {\n        _.each(templateVariable.current.value, function(value) {\n          if (value === \"$__all\") {\n            _.each(templateVariable.options, function(option) {\n              // \"All\" is part of the options, so make sure to skip that one\n              if (option.value !== \"$__all\") {\n                variable.value.push(option.value);\n              }\n            });\n          } else {\n            variable.value.push(value);\n          }\n        });\n      }\n\n      variables.push(variable);\n    });\n    return interpolate(object, attributes, variables, callback);\n  }\n\n  static processMeasurementsResponse(response) {\n    var labels = response.data.labels;\n    var columns = response.data.columns;\n    var timestamps = response.data.timestamps;\n    var series = [];\n    var i, j, nRows, nCols, datapoints;\n\n    if (timestamps !== undefined) {\n      nRows = timestamps.length;\n      nCols = columns.length;\n\n      for (i = 0; i < nCols; i++) {\n        datapoints = [];\n        for (j = 0; j < nRows; j++) {\n          // Skip rows that are out-of-ranges - this can happen with RRD data in narrow time spans\n          if (timestamps[j] < response.data.start || timestamps[j] > response.data.end) {\n            continue;\n          }\n\n          datapoints.push([columns[i].values[j], timestamps[j]]);\n        }\n\n        series.push({\n          target: labels[i],\n          datapoints: datapoints\n        });\n      }\n    }\n\n    return {data: series};\n  }\n\n  static flattenResourcesWithAttributes(resources, resourcesWithAttributes) {\n    _.each(resources, function (resource) {\n      if (resource.rrdGraphAttributes !== undefined && Object.keys(resource.rrdGraphAttributes).length > 0) {\n        resourcesWithAttributes.push(resource);\n      }\n      if (resource.children !== undefined && resource.children.resource.length > 0) {\n        OpenNMSDatasource.flattenResourcesWithAttributes(resource.children.resource, resourcesWithAttributes);\n      }\n    });\n    return resourcesWithAttributes;\n  }\n\n  static getNodeResource(nodeId) {\n    var prefix = \"\";\n    if (nodeId.indexOf(\":\") > 0) {\n      prefix = \"nodeSource[\";\n    } else {\n      prefix = \"node[\";\n    }\n    return prefix + nodeId + \"]\";\n  }\n\n  static getRemoteResourceId(nodeId, resourceId) {\n    return OpenNMSDatasource.getNodeResource(nodeId) + \".\" + resourceId;\n  }\n\n  searchForNodes(query) {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/nodes',\n      method: 'GET',\n      params: {\n        limit: this.searchLimit,\n        match: 'any',\n        comparator: 'ilike',\n        orderBy: 'id',\n        order: 'asc',\n        label: '%' + query + '%',\n        sysName: '%' + query + '%',\n        'ipInterface.ipAddress': '%' + query + '%',\n        'ipInterface.ipHostName': '%' + query + '%',\n        'foreignId': query + '%' // doesn't support leading '%'\n      }\n    });\n  }\n\n  getResourcesWithAttributesForNode(nodeId) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId));\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/resources/fornode/' + encodeURIComponent(interpolatedNodeId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      return OpenNMSDatasource.flattenResourcesWithAttributes([results.data], []);\n    });\n  }\n\n  getAvailableFilters() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/measurements/filters',\n      method: 'GET'\n    });\n  }\n\n  suggestAttributes(nodeId, resourceId, query) {\n    var interpolatedNodeId = _.first(this.interpolateValue(nodeId)),\n        interpolatedResourceId = _.first(this.interpolateValue(resourceId));\n    var remoteResourceId = OpenNMSDatasource.getRemoteResourceId(interpolatedNodeId, interpolatedResourceId);\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/rest/resources/' + encodeURIComponent(remoteResourceId),\n      method: 'GET',\n      params: {\n        depth: -1\n      }\n    }).then(function (results) {\n      query = query.toLowerCase();\n      var attributes = [];\n      _.each(results.data.rrdGraphAttributes, function (value, key) {\n        if (key.toLowerCase().indexOf(query) >= 0) {\n          attributes.push(key);\n        }\n      });\n      attributes.sort();\n\n      return attributes;\n    });\n  }\n}\n"]}