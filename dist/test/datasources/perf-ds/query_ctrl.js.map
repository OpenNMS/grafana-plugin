{"version":3,"sources":["../../../../src/datasources/perf-ds/query_ctrl.js"],"names":["OpenNMSQueryCtrl","$rootScope","$scope","$injector","$q","$modal","types","error","validateTarget","self","showSelectionModal","query","datasource","searchForNodes","then","results","data","count","totalCount","node","isUndefined","foreignId","isNull","foreignSource","target","nodeId","id","targetBlur","filterResources","resources","filteredResources","length","toLowerCase","filter","resource","key","indexOf","take","searchLimit","nodeResources","undefined","deferred","defer","resolve","promise","getResourcesWithAttributesForNode","each","label","name","sortBy","re","match","exec","resourceId","suggestAttributes","attributes","namedAttributes","attribute","push","getAvailableFilters","columns","search","callback","scope","$new","result","modal","template","persist","show","keyboard","when","modalEl","refresh","type","Attribute","Expression","expression","Filter","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import './modal_ctrl';\nimport {QueryType} from './constants';\nimport {QueryCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\n\nexport class OpenNMSQueryCtrl extends QueryCtrl {\n\n  constructor($rootScope, $scope, $injector, $q, $modal) {\n    super($scope, $injector);\n\n    this.types = QueryType;\n\n    this.error = this.validateTarget();\n    this.$rootScope = $rootScope;\n    this.$q = $q;\n    this.$modal = $modal;\n  }\n\n  openNodeSelectionModal() {\n    var self = this;\n    this.showSelectionModal(\"nodes\", {\n      '#': 'id',\n      'Label': 'label',\n      'Foreign ID': 'foreignId',\n      'sysName': 'sysName'\n    }, function (query) {\n      return self.datasource\n        .searchForNodes(query)\n        .then(function (results) {\n          return {\n            'count': results.data.count,\n            'totalCount': results.data.totalCount,\n            'rows': results.data.node\n          };\n        });\n    }, function (node) {\n      if (!_.isUndefined(node.foreignId) && !_.isNull(node.foreignId)\n        && !_.isUndefined(node.foreignSource) && !_.isNull(node.foreignSource)) {\n        // Prefer fs:fid\n        self.target.nodeId = node.foreignSource + \":\" + node.foreignId;\n      } else {\n        // Fallback to node id\n        self.target.nodeId = node.id;\n      }\n      self.targetBlur();\n    });\n  }\n\n  openResourceSelectionModal() {\n    var self = this;\n\n    function filterResources(resources, query) {\n      var filteredResources = resources;\n      if (query.length >= 1) {\n        query = query.toLowerCase();\n        filteredResources = _.filter(resources, function (resource) {\n          return resource.key.indexOf(query) >= 0;\n        });\n      }\n\n      // Limit the results - it takes along time to render if there are too many\n      var totalCount = filteredResources.length;\n      filteredResources = _.take(filteredResources, self.datasource.searchLimit);\n\n      return {\n        'count': filteredResources.length,\n        'totalCount': totalCount,\n        'rows': filteredResources\n      };\n    }\n\n    self.nodeResources = undefined;\n    this.showSelectionModal(\"resources\", {\n      'Label': 'label',\n      'Name': 'name'\n    }, function (query) {\n      if (self.nodeResources !== undefined) {\n        var deferred = self.$q.defer();\n        deferred.resolve(filterResources(self.nodeResources, query));\n        return deferred.promise;\n      }\n\n      return self.datasource.getResourcesWithAttributesForNode(self.target.nodeId)\n        .then(function (resources) {\n          // Compute a key for more efficient searching\n          _.each(resources, function (resource) {\n            resource.key = resource.label.toLowerCase() + resource.name.toLowerCase();\n          });\n          // Sort the list once\n          self.nodeResources = _.sortBy(resources, function (resource) {\n            return resource.label;\n          });\n          // Filter\n          return filterResources(self.nodeResources, query);\n        });\n    }, function (resource) {\n      // Exclude the node portion of the resource id\n      var re = /node(Source)?\\[.*?]\\.(.*)$/;\n      var match = re.exec(resource.id);\n      self.target.resourceId = match[2];\n      self.targetBlur();\n    });\n  }\n\n  openAttributeSelectionModal() {\n    var self = this;\n    this.showSelectionModal(\"attributes\", {\n      'Name': 'name'\n    }, function (query) {\n      return self.datasource\n        .suggestAttributes(self.target.nodeId, self.target.resourceId, query)\n        .then(function (attributes) {\n          var namedAttributes = [];\n          _.each(attributes, function (attribute) {\n            namedAttributes.push({'name': attribute});\n          });\n\n          return {\n            'count': namedAttributes.length,\n            'totalCount': namedAttributes.length,\n            'rows': namedAttributes\n          };\n        });\n    }, function (attribute) {\n      self.target.attribute = attribute.name;\n      self.targetBlur();\n    });\n  }\n\n  openFilterSelectionModal() {\n    var self = this;\n    this.showSelectionModal(\"filters\", {\n      'Name': 'name',\n      'Description': 'description',\n      'Backend': 'backend'\n    }, function () {\n      return self.datasource\n        .getAvailableFilters()\n        .then(function (results) {\n          return {\n            'count': results.data.length,\n            'totalCount': results.data.length,\n            'rows': results.data\n          };\n        });\n    }, function (filter) {\n      self.target.filter = filter;\n      self.targetBlur();\n    });\n  }\n\n  showSelectionModal(label, columns, search, callback) {\n    var scope = this.$rootScope.$new();\n\n    scope.label = label;\n    scope.columns = columns;\n    scope.search = search;\n\n    scope.result = this.$q.defer();\n    scope.result.promise.then(callback);\n\n    var modal = this.$modal({\n      template: 'public/plugins/opennms-helm/datasources/perf-ds/partials/modal.selection.html',\n      persist: false,\n      show: false,\n      scope: scope,\n      keyboard: false\n    });\n    this.$q.when(modal).then(function (modalEl) { modalEl.modal('show'); });\n  }\n\n  targetBlur() {\n    this.error = this.validateTarget();\n    this.refresh();\n  }\n\n  validateTarget() {\n    if (this.target.type === QueryType.Attribute) {\n      if (!this.target.nodeId) {\n        return \"You must supply a node id.\";\n      } else if (!this.target.resourceId) {\n        return \"You must supply a resource id.\";\n      } else if (!this.target.attribute) {\n        return \"You must supply an attribute.\";\n      }\n    } else if (this.target.type === QueryType.Expression) {\n      if (!this.target.label) {\n        return \"You must supply a label.\";\n      } else if (!this.target.expression) {\n        return \"You must supply an expression.\";\n      }\n    } else if (this.target.type === QueryType.Filter) {\n      if (!this.target.filter) {\n        return \"You must select a filter.\";\n      }\n    } else {\n      return \"Invalid type.\";\n    }\n\n    return undefined;\n  }\n\n  getCollapsedText() {\n    if (this.target.type === QueryType.Attribute) {\n      return \"Attribute: \" + this.target.attribute;\n    } else if (this.target.type === QueryType.Expression) {\n      return \"Expression: \" + this.target.label;\n    } else if (this.target.type === QueryType.Filter) {\n      return \"Filter: \" + this.target.filter.name;\n    } else {\n      return \"<Incomplete>\";\n    }\n  }\n}\n\nOpenNMSQueryCtrl.templateUrl = 'datasources/perf-ds/partials/query.editor.html';\n"]}