{"version":3,"sources":["../../../../src/datasources/perf-ds/interpolate.js"],"names":["interpolate","cartesianProductOfArrays","arrays","r","max","length","helper","arr","i","j","l","a","slice","push","cartesianProductOfVariables","variables","allValues","each","variable","value","productOfAllValues","productOfAllVariables","rowOfValues","rowOfVariables","JSON","parse","stringify","defaultContainsVariable","variableName","isNull","isEmpty","indexOf","defaultReplace","interpolatedValue","replace","name","object","attributes","callback","containsVariable","undefined","variablesWithIndex","clone","referencedVariables","isVariableReferenced","find","attribute","objects","index","rowOfReferencedVariables","o"],"mappings":"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","file":"interpolate.js","sourcesContent":["import _ from 'lodash';\n\nfunction cartesianProductOfArrays(arrays) {\n  // Based on the code from http://stackoverflow.com/questions/15298912/\n  // javascript-generating-combinations-from-n-arrays-with-m-elements\n  var r = [], max = arrays.length - 1;\n\n  function helper(arr, i) {\n    for (var j = 0, l = arrays[i].length; j < l; j++) {\n      var a = arr.slice(0); // clone arr\n      a.push(arrays[i][j]);\n      if (i === max) {\n        r.push(a);\n      } else {\n        helper(a, i + 1);\n      }\n    }\n  }\n\n  helper([], 0);\n  return r;\n}\n\nfunction cartesianProductOfVariables(variables) {\n  // Collect the values from all of the variables\n  var allValues = [];\n  _.each(variables, function (variable) {\n    allValues.push(variable.value);\n  });\n\n  // Generate the cartesian product\n  var productOfAllValues = cartesianProductOfArrays(allValues);\n\n  // Rebuild the variables\n  var productOfAllVariables = [];\n  _.each(productOfAllValues, function (rowOfValues) {\n    var rowOfVariables = [];\n    for (var i = 0, l = variables.length; i < l; i++) {\n      // Deep clone\n      var variable = JSON.parse(JSON.stringify(variables[i]));\n      variable.value = rowOfValues[i];\n      rowOfVariables.push(variable);\n    }\n    productOfAllVariables.push(rowOfVariables);\n  });\n\n  return productOfAllVariables;\n}\n\nfunction defaultContainsVariable(value, variableName) {\n  if (_.isNull(value) || _.isEmpty(value)) {\n    return false;\n  }\n  return value.indexOf(\"$\" + variableName) >= 0;\n}\n\nfunction defaultReplace(value, variables) {\n  if (_.isNull(value) || _.isEmpty(value)) {\n    return value;\n  }\n  var interpolatedValue = value;\n  _.each(variables, function (variable) {\n    interpolatedValue = interpolatedValue.replace(\"$\" + variable.name, variable.value);\n  });\n  return interpolatedValue;\n}\n\n/**\n * Replaces the object's attributes with the values of the referenced variables.\n *\n * If a referenced variable contains multiple values or if there are multiple referenced variables\n * then we generate copies of the object with all of the possible permutations.\n *\n * See interpolate_spec.js for examples.\n *\n * @param object\n *    the object to interpolate\n * @param attributes\n *    a list of attributes on a given object that should be checked for variables\n * @param variables\n *    a list of variables of the form [{name: 'varname', value: ['value1', 'value2']}, ...]\n * @param callback\n *    an optional callback made with the object after variable substitution has been performed\n * @param containsVariable\n *    optionally override the function used to determine if a string contains a reference to the named variable\n * @param replace\n *    optionally override the function used to substitute the variable reference in a string with the variables's value\n * @returns an array of objects, if no substitutions were performed, the array will contain the original object\n */\nexport function interpolate(object, attributes, variables, callback, containsVariable, replace) {\n  // Use default for the functions when undefined\n  if (callback === undefined) {\n    callback = () => {};\n  }\n  if (containsVariable === undefined) {\n    containsVariable = defaultContainsVariable;\n  }\n  if (replace === undefined) {\n    replace = defaultReplace;\n  }\n\n  // Add the index variable with a single value\n  var variablesWithIndex = _.clone(variables);\n  variablesWithIndex.push({name: 'index', value: [0]});\n\n  // Collect the list of variables that are referenced by one or more of the keys\n  var referencedVariables = [];\n  _.each(variablesWithIndex, function (variable) {\n    var isVariableReferenced = _.find(attributes, function (attribute) {\n      return containsVariable(object[attribute], variable.name);\n    });\n\n    if (isVariableReferenced) {\n      referencedVariables.push(variable);\n    }\n  });\n\n  if (referencedVariables.length < 1) {\n    // No variables are referenced, nothing to substitute\n    callback(object);\n    return [object];\n  }\n\n  // Generate all possible permutations of the referenced variable's values\n  var productOfAllVariables = cartesianProductOfVariables(referencedVariables);\n\n  // Perform the required variable substitution\n  var objects = [];\n  var index = 0;\n  _.each(productOfAllVariables, function (rowOfReferencedVariables) {\n    // Update the value of the index variable to reflect the index of the row\n    _.each(rowOfReferencedVariables, function (variable) {\n      if (variable.name === 'index') {\n        variable.value = 'idx' + index;\n        index += 1;\n      }\n    });\n\n    var o = _.clone(object);\n    _.each(attributes, function (attribute) {\n      o[attribute] = replace(o[attribute], rowOfReferencedVariables);\n    });\n\n    callback(o);\n\n    objects.push(o);\n  });\n\n  return objects;\n}\n"]}