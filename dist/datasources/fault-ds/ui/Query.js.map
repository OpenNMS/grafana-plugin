{"version":3,"sources":["../../../../src/datasources/fault-ds/ui/Query.js"],"names":["_","UI","Query","uiSegmentSrv","parentQuery","clauses","root","getSize","length","createNewEmptyClause","self","each","clause","updateControls","index","undefined","splice","push","indexOf","isEmpty","map","string","restriction","subString","asString","restrictionString","message","operator","value","toLowerCase","join","newClause","Clause","Operators","AND","Restriction","addSegment","newKey","KEY_PLACEHOLDER","newOperator","newFake","VALUE_PLACEHOLDER","addClause","newQuery","findParent"],"mappings":"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","file":"Query.js","sourcesContent":["import _ from 'lodash';\nimport {UI} from '../UI';\n\nexport class Query {\n\n    constructor(uiSegmentSrv, parentQuery) {\n        this.uiSegmentSrv = uiSegmentSrv;\n        this.clauses = [];\n        this.root = false;\n        this.parentQuery = parentQuery;\n    }\n\n    clear() {\n        this.clauses = [];\n    }\n\n    isEmpty() {\n        return this.getSize() == 0;\n    }\n\n    getSize() {\n        return this.clauses.length;\n    }\n\n    getLastClause() {\n        if (this.clauses.length == 0) {\n            return null;\n        }\n        return this.clauses[this.getSize() - 1];\n    }\n\n    updateControls() {\n        // at least one row should be available even if it is a dummy row\n        if (this.getSize() == 0) {\n            this.createNewEmptyClause();\n        }\n        var self = this;\n        _.each(this.clauses, clause => {\n            clause.updateControls(self);\n        });\n    }\n\n    addClause(clause, index) {\n        if (clause) {\n            if (!clause.uiSegmentSrv) {\n                clause.uiSegmentSrv = this.uiSegmentSrv;\n            }\n            if (index !== undefined) {\n                this.clauses.splice(index, 0, clause);\n            } else {\n                this.clauses.push(clause);\n            }\n        }\n    }\n\n    removeClause(clause) {\n        if (clause) {\n            var index = this.clauses.indexOf(clause);\n            if (index >= 0) {\n                this.clauses.splice(index, 1);\n                return true;\n            }\n        }\n        return false;\n    }\n\n    asString() {\n        if (this.isEmpty()) {\n            return \"\";\n        }\n        return _.map(this.clauses, function(clause, index) {\n            let string = '';\n            if (clause.restriction instanceof UI.Query) {\n                const subString = clause.restriction.asString();\n                if (subString && subString.length > 0) {\n                    string += \"(\" + subString + \")\";\n                }\n            } else if (clause.restriction) {\n                const restrictionString = clause.restriction.asString();\n                if (restrictionString && restrictionString.length > 0) {\n                    string += restrictionString;\n                }\n            } else {\n                throw {message: \"Clause does not contain restriction. Bailing\", clause: clause};\n            }\n\n            // Append operator if we have anything generated\n            if (string.length > 0  && index > 0 && clause.operator && clause.operator.value) {\n                string = \" \" + clause.operator.value.toLowerCase() + \" \" + string;\n            }\n            return string;\n        }).join(\"\");\n    }\n\n    createNewEmptyClause(index) {\n        const newClause = new UI.Clause(this.uiSegmentSrv, UI.Operators.AND, new UI.Restriction(this.uiSegmentSrv));\n        newClause.restriction.addSegment(this.uiSegmentSrv.newKey(UI.Restriction.KEY_PLACEHOLDER));\n        newClause.restriction.addSegment(this.uiSegmentSrv.newOperator('='));\n        newClause.restriction.addSegment(this.uiSegmentSrv.newFake(UI.Restriction.VALUE_PLACEHOLDER, 'value', 'query-segment-value'));\n        this.addClause(newClause, index);\n        return newClause;\n    }\n\n    createNewEmptyNestedClause(index) {\n        const newQuery = new UI.Query(this.uiSegmentSrv, this);\n        newQuery.createNewEmptyClause();\n        const newClause = new UI.Clause(this.uiSegmentSrv, UI.Operators.AND, newQuery);\n        this.addClause(newClause, index);\n        return newQuery;\n    }\n\n    findParent() {\n        if (this.parentQuery) {\n            return this.parentQuery.findParent();\n        }\n        return this;\n    };\n}\n"]}